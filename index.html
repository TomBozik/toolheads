<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolheads Collector</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="h-full min-h-screen bg-slate-900 text-gray-200 flex flex-col" x-data="alpineInstance()">

    <div class="h-full p-4 lg:p-8">
        <h1 class="mt-0 mb-3 text-3xl" x-text="title"></h1>
        <p class="text-xl font-light mb-4" x-html="intro"></p>

        <div class="flex items-center">
            <input type="text" name="walletSearch" x-model="walletSearch" class="flex w-2/3 bg-slate-700 focus:outline-none focus:shadow-outline border border-gray-300 rounded-lg py-2 px-4 appearance-none leading-normal">
            <button type="submit" @click="fetchData()" class="flex bg-sky-500 text-white font-semibold py-2 px-4 rounded hover:bg-sky-700 ml-2" :class="[ isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-sky-700' ]" :disabled="isLoading">
                Search
            </button>
        </div>       
        <template x-if="isError">
            <div class="pt-2 font-bold text-red-600" x-text="error"></div>
        </template> 
    </div>

    <div class="h-full px-4 lg:px-8 flex-1">
        <template x-for="role in toolheadRoles" :key="role.name">
            <div class="pb-4">
                <div x-text="`${role.name} (${role.data.length})`"></div>
                <div class="flex flex-row flex-wrap">
                    <template x-for="toolhead in role.data" :key="toolhead.fingerprint" >
                        <a class="pr-2 pt-1" x-bind:href="`https://pool.pm/${toolhead.fingerprint}`" target="_blank">
                            <img x-bind:src="`https://images.cnft.tools/ipfs/${toolhead.image}`" class="rounded-md h-24" />
                        </a>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- poker -->
    <div class="h-full px-4 lg:px-8 flex-1">
        <div class="text-xl mb-2 mt-6">Poker Attributes</div>
        <template x-for="poker in pokerHeads" :key="poker.name">
            <div class="pb-4">
                <div x-text="`${poker.name} (${poker.data.length})`"></div>
                <div class="flex flex-row flex-wrap">
                    <template x-for="toolhead in poker.data" :key="toolhead.fingerprint" >
                        <a class="pr-2 pt-1" x-bind:href="`https://pool.pm/${toolhead.fingerprint}`" target="_blank">
                            <img x-bind:src="`https://images.cnft.tools/ipfs/${toolhead.image}`" class="rounded-md h-24" />
                        </a>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <div class="flex flex-col text-center text-xs text-gray-500">
        <div><a href="https://twitter.com/T__o__m__b__o" target="_blank" class="hover:text-sky-500">Tombo</a></div>
    </div>
</body>
</html>

<script>
    function alpineInstance() {
        return {
            title: 'Toolheads Collector',
            intro: 'Type the <code class="text-md text-sky-500">address or $handle</code> of your Cardano wallet:',
            policyId: '285c0b8e91ba323da4ca083c9db837e111dafbf3143ece4d03eba8f4',
            walletSearch: localStorage.getItem("address") || '',
            isLoading: false,
            isError: false,
            error: '',

            toolheadRoles : [
                {name: 'Necromancer', data:[]},
                {name: 'Star Legion', data:[]},
                {name: 'Atomic Merchant', data:[]},
                {name: 'Cyber Shogun', data:[]},
                {name: 'Shadow Shogun', data:[]},
                {name: 'Mutant Trader', data:[]},
                {name: 'Terraformer', data:[]},
                {name: 'Vault Guard', data:[]},
                {name: 'Blade', data:[]},
                {name: 'Bot', data:[]},
                {name: 'Hacker', data:[]},
                {name: 'Enforcer', data:[]},
                {name: 'Quantum Chemist', data:[]},
                {name: 'Anarchist', data:[]},
                {name: 'Marauder', data:[]},
                {name: 'Defender', data:[]},
            ],

            pokerHeads: [
                {name: 'Club', data:[]},
                {name: 'Heart', data:[]},
                {name: 'Diamond', data:[]},
                {name: 'Spade', data:[]},
            ],

            async fetchData() {
                try {
                    this.isLoading = true;
                    this.isError = false;
                    this.error = '';
                    localStorage.setItem('address', this.walletSearch);
                    
                    const response = await fetch(`https://pool.pm/wallet/${this.walletSearch}`);
                    const data = await response.json();
                    const walletToolheads = data.tokens.filter(token => { return token.policy === this.policyId });
                    
                    walletToolheads.forEach(toolhead => {
                        let roleIndex = this.toolheadRoles.findIndex(role => role.name === toolhead['metadata']['attributes']['role']);
                        this.toolheadRoles[roleIndex]['data'].push({
                            'fingerprint': toolhead['fingerprint'],
                            'tk256': toolhead['tk256'],
                            'image': toolhead['metadata']['image'].match(/\/\/(.*)/)[1]
                        })

                        // poker
                        let headAttributes = toolhead['metadata']['attributes']['head'];
                        this.pokerHeads.forEach((head, i) => {
                            if(headAttributes.indexOf(head.name) > -1) { 
                                this.pokerHeads[i]['data'].push({
                                    'fingerprint': toolhead['fingerprint'],
                                    'tk256': toolhead['tk256'],
                                    'image': toolhead['metadata']['image'].match(/\/\/(.*)/)[1]
                                })
                            }
                        })

                    });
                } catch(e) {
                    this.isError = true;
                    this.error = "Error :(";
                }
                this.isLoading = false; 
            },
        }
    }
</script>